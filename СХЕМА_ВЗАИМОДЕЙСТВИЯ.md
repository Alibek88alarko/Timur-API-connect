# СХЕМА ВЗАИМОДЕЙСТВИЯ СИСТЕМЫ TIMUR-API-CONNECT

## 📊 ОБЩАЯ СХЕМА ДАННЫХ

```
┌─────────────────────┐    ┌──────────────────────┐    ┌─────────────────────┐
│   Al-Style.kz       │    │   НАШ СЕРВЕР         │    │    Kaspi.kz         │
│ (Поставщик товаров) │◄──►│  (Обработчик)        │◄──►│ (Маркетплейс)       │
└─────────────────────┘    └──────────────────────┘    └─────────────────────┘
   📍 79.143.22.75           📍 Любой IP               📍 api.kaspi.kz
   🔒 Статический IP         🔒 Динамический подходит   🔒 Статический IP
```

## 🔄 ДЕТАЛЬНАЯ СХЕМА ВЗАИМОДЕЙСТВИЯ

### 1️⃣ ПОЛУЧЕНИЕ ДАННЫХ О ТОВАРАХ (Al-Style → Наш Сервер)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            Al-Style API                                     │
│                         api.al-style.kz                                     │
│                       IP: 79.143.22.75                                      │
│                                                                             │
│  📦 250+ товаров с полными данными:                                         │
│  • Артикулы, названия, цены                                                │
│  • Количество на складе                                                    │
│  • Бренды, категории                                                       │
│  • Изображения товаров                                                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼ GET запросы каждые 5 секунд
                                    │ Token: fTjmIXfcC0F1F_lykYdkCPOqNJDXp_xm
┌─────────────────────────────────────────────────────────────────────────────┐
│                             НАШ СЕРВЕР                                      │
│                         (Любой IP адрес)                                   │
│                                                                             │
│  🖥️ Скрипт Script.py:                                                       │
│  • get_al_style_products() - загружает товары                              │
│  • update_kaspi_prices_stock() - создает XML                               │
│  • process_kaspi_orders() - обрабатывает заказы                            │
│  • upload_xml_to_kaspi() - отправляет каталог                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2️⃣ ОТПРАВКА КАТАЛОГА ТОВАРОВ (Наш Сервер → Kaspi)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                             НАШ СЕРВЕР                                      │
│                                                                             │
│  📄 Создание XML файла:                                                     │
│  • kaspi_price_list.xml                                                    │
│  • 248 товаров в формате Kaspi                                             │
│  • Структура: model → brand → availabilities → price                       │
│  • Валидация через xml_validator.py                                        │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼ POST multipart/form-data
                                    │ API Token из кабинета продавца
┌─────────────────────────────────────────────────────────────────────────────┐
│                            Kaspi.kz API                                     │
│                         api.kaspi.kz                                        │
│                                                                             │
│  🏪 Автоматическая обработка:                                               │
│  • Загрузка XML каждые 60 минут                                            │
│  • Обновление цен и остатков                                               │
│  • Публикация товаров на сайте                                             │
│  • Создание карточек товаров                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3️⃣ ОБРАБОТКА ЗАКАЗОВ (Kaspi → Наш Сервер)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Kaspi.kz (Покупатели)                              │
│                                                                             │
│  🛒 Покупатели делают заказы:                                               │
│  • Выбирают товары из нашего каталога                                      │
│  • Оформляют заказы через Kaspi.kz                                         │
│  • Оплачивают через Kaspi Pay                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼ Уведомления о заказах
                                    │
┌─────────────────────────────────────────────────────────────────────────────┐
│                             НАШ СЕРВЕР                                      │
│                        (Polling каждые 5 минут)                            │
│                                                                             │
│  🔄 Обработка заказов:                                                      │
│  • GET /orders - получаем новые заказы                                     │
│  • Анализируем доступность товаров                                         │
│  • POST /orders - подтверждаем или отклоняем                               │
│  • Отправляем данные в Al-Style для резерва                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼ POST запросы с данными заказа
                                    │
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Al-Style.kz                                       │
│                        (Резерв и отгрузка)                                  │
│                                                                             │
│  📦 Выполнение заказа:                                                      │
│  • Резервирование товаров                                                  │
│  • Подготовка к отгрузке                                                   │
│  • Обновление остатков                                                     │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 📋 ТЕХНИЧЕСКИЕ ДЕТАЛИ

### 🌐 IP-адреса и домены:
- **Al-Style API**: `79.143.22.75` (api.al-style.kz) - СТАТИЧЕСКИЙ
- **Kaspi API**: `api.kaspi.kz` - СТАТИЧЕСКИЙ  
- **Наш сервер**: ЛЮБОЙ IP (динамический подходит)

### 🔐 Авторизация:
- **Al-Style**: Token `fTjmIXfcC0F1F_lykYdkCPOqNJDXp_xm`
- **Kaspi**: API Token из кабинета продавца

### ⏰ Частота обновлений:
- **Товары Al-Style**: каждые 5 секунд (лимит API)
- **XML на Kaspi**: каждые 60 минут (автоматически)
- **Заказы Kaspi**: каждые 5 минут (polling)
- **Расписание**: 09:00, 15:00, 21:45 (основные синхронизации)

### 📊 Объемы данных:
- **Al-Style**: 250+ товаров
- **Kaspi XML**: 248 товаров (успешно загружено)
- **Заказы**: по мере поступления

## 🏗️ АРХИТЕКТУРА РЕШЕНИЯ

```
Internet
    │
    ├── Al-Style.kz (79.143.22.75) ◄─── НАШ СЕРВЕР ─────► Kaspi.kz
    │                                      │
    │                                      ▼
    └── Клиенты Kaspi.kz              XML файлы
                                    Логи операций
                                   Конфигурация
```

### 📁 Структура проекта:
- `Script.py` - основной скрипт интеграции
- `config.py` - настройки и токены
- `xml_validator.py` - валидация XML
- `kaspi_auto_uploader.py` - автоматизация
- `requirements.txt` - зависимости Python

## 💰 ЭКОНОМИЧЕСКИЕ ПРЕИМУЩЕСТВА

✅ **Не нужен статический IP** (экономия ~5000 тенге/месяц)  
✅ **Автоматизация** - минимум ручной работы  
✅ **Масштабируемость** - легко добавить других поставщиков  
✅ **Надежность** - контроль ошибок и логирование
