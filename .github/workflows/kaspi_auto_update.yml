name: Auto Update Kaspi Price List

# Автоматическое обновление прайс-листа для Kaspi.kz
# Запускается каждый день в 6:00, 12:00, 18:00 UTC (9:00, 15:00, 21:00 MSK)

on:
  # Расписание (cron) - КАЖДЫЕ 2 ЧАСА (БЕСПЛАТНО!)
  schedule:
    - cron: '0 */2 * * *'   # Каждые 2 часа (00:00, 02:00, 04:00, 06:00, 08:00, 10:00, 12:00, 14:00, 16:00, 18:00, 20:00, 22:00)
  
  # Ручной запуск через GitHub UI
  workflow_dispatch:
  
  # Запуск при пуше (для тестирования)
  push:
    branches:
      - main
    paths:
      - 'Script.py'
      - 'config.py'
      - '.github/workflows/kaspi_auto_update.yml'

jobs:
  update-price-list:
    name: Update Kaspi Price List
    runs-on: ubuntu-latest
    
    steps:
      # 1. Клонируем репозиторий
      - name: 📥 Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # 2. Устанавливаем Python
      - name: 🐍 Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      # 3. Устанавливаем зависимости
      - name: 📦 Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # 4. Создаём .env файл с секретами
      - name: 🔐 Create .env file
        run: |
          cat > .env << EOF
          # Al-Style API
          AL_STYLE_TOKEN=${{ secrets.AL_STYLE_TOKEN }}
          
          # Kaspi API
          KASPI_TOKEN=${{ secrets.KASPI_TOKEN }}
          EOF
      
      # 5. Генерируем XML прайс-лист
      - name: 🏭 Generate XML price list
        run: |
          echo "🚀 Генерация XML прайс-листа..."
          python Script.py test-xml
          
          # Проверяем, что файл создан
          if [ -f "kaspi_price_list.xml" ]; then
            echo "✅ XML файл успешно создан"
            ls -lh kaspi_price_list.xml
          else
            echo "❌ Ошибка: XML файл не создан"
            exit 1
          fi
      
      # 6. Публикуем XML в репозиторий
      - name: 📤 Commit and push XML
        run: |
          git config --global user.name "Kaspi Auto Bot"
          git config --global user.email "bot@kaspi-auto.com"
          
          # Добавляем файл
          git add kaspi_price_list.xml
          
          # Создаём коммит (если есть изменения)
          if git diff --staged --quiet; then
            echo "ℹ️ Нет изменений в прайс-листе"
          else
            git commit -m "🤖 Auto update: price list $(date '+%Y-%m-%d %H:%M:%S UTC')"
            git push
            echo "✅ XML опубликован на GitHub"
          fi
      
      # 7. Выводим публичный URL
      - name: 🌐 Display public URL
        run: |
          echo "═══════════════════════════════════════════════════════════"
          echo "✅ ОБНОВЛЕНИЕ ЗАВЕРШЕНО"
          echo "═══════════════════════════════════════════════════════════"
          echo ""
          echo "📋 Публичный URL для Kaspi.kz:"
          echo "https://raw.githubusercontent.com/${{ github.repository }}/main/kaspi_price_list.xml"
          echo ""
          echo "⏰ Следующее обновление: через 2 часа (12 раз в день автоматически)"
          echo ""
          echo "═══════════════════════════════════════════════════════════"
