name: Auto Update Kaspi Price List

# ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð°Ð¹Ñ-Ð»Ð¸ÑÑ‚Ð° Ð´Ð»Ñ Kaspi.kz
# Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð² 6:00, 12:00, 18:00 UTC (9:00, 15:00, 21:00 MSK)

on:
  # Ð Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ (cron) - ÐšÐÐ–Ð”Ð«Ð• 2 Ð§ÐÐ¡Ð (Ð‘Ð•Ð¡ÐŸÐ›ÐÐ¢ÐÐž!)
  schedule:
    - cron: '0 */2 * * *'   # ÐšÐ°Ð¶Ð´Ñ‹Ðµ 2 Ñ‡Ð°ÑÐ° (00:00, 02:00, 04:00, 06:00, 08:00, 10:00, 12:00, 14:00, 16:00, 18:00, 20:00, 22:00)
  
  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ñ‡ÐµÑ€ÐµÐ· GitHub UI
  workflow_dispatch:
  
  # Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸ Ð¿ÑƒÑˆÐµ (Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ)
  push:
    branches:
      - main
    paths:
      - 'Script.py'
      - 'config.py'
      - '.github/workflows/kaspi_auto_update.yml'

jobs:
  update-price-list:
    name: Update Kaspi Price List
    runs-on: ubuntu-latest
    
    steps:
      # 1. ÐšÐ»Ð¾Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # 2. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Python
      - name: ðŸ Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      # 3. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # 4. Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ .env Ñ„Ð°Ð¹Ð» Ñ ÑÐµÐºÑ€ÐµÑ‚Ð°Ð¼Ð¸
      - name: ðŸ” Create .env file
        run: |
          cat > .env << EOF
          # Al-Style API
          AL_STYLE_TOKEN=${{ secrets.AL_STYLE_TOKEN }}
          
          # Kaspi API
          KASPI_TOKEN=${{ secrets.KASPI_TOKEN }}
          EOF
      
      # 5. Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ XML Ð¿Ñ€Ð°Ð¹Ñ-Ð»Ð¸ÑÑ‚
      - name: ðŸ­ Generate XML price list
        run: |
          echo "ðŸš€ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ XML Ð¿Ñ€Ð°Ð¹Ñ-Ð»Ð¸ÑÑ‚Ð°..."
          python Script.py test-xml
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½
          if [ -f "kaspi_price_list.xml" ]; then
            echo "âœ… XML Ñ„Ð°Ð¹Ð» ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½"
            ls -lh kaspi_price_list.xml
          else
            echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: XML Ñ„Ð°Ð¹Ð» Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð½"
            exit 1
          fi
      
      # 6. ÐŸÑƒÐ±Ð»Ð¸ÐºÑƒÐµÐ¼ XML Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹
      - name: ðŸ“¤ Commit and push XML
        run: |
          git config --global user.name "Kaspi Auto Bot"
          git config --global user.email "bot@kaspi-auto.com"
          
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ„Ð°Ð¹Ð»
          git add kaspi_price_list.xml
          
          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚ (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ)
          if git diff --staged --quiet; then
            echo "â„¹ï¸ ÐÐµÑ‚ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð² Ð¿Ñ€Ð°Ð¹Ñ-Ð»Ð¸ÑÑ‚Ðµ"
          else
            git commit -m "ðŸ¤– Auto update: price list $(date '+%Y-%m-%d %H:%M:%S UTC')"
            git push
            echo "âœ… XML Ð¾Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½ Ð½Ð° GitHub"
          fi
      
      # 7. Ð’Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ URL
      - name: ðŸŒ Display public URL
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… ÐžÐ‘ÐÐžÐ’Ð›Ð•ÐÐ˜Ð• Ð—ÐÐ’Ð•Ð Ð¨Ð•ÐÐž"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“‹ ÐŸÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ URL Ð´Ð»Ñ Kaspi.kz:"
          echo "https://raw.githubusercontent.com/${{ github.repository }}/main/kaspi_price_list.xml"
          echo ""
          echo "â° Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰ÐµÐµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ: Ñ‡ÐµÑ€ÐµÐ· 2 Ñ‡Ð°ÑÐ° (12 Ñ€Ð°Ð· Ð² Ð´ÐµÐ½ÑŒ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸)"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
